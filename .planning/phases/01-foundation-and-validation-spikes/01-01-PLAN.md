---
phase: 01-foundation-and-validation-spikes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/autoloads/event_bus.gd
  - scripts/autoloads/save_data.gd
  - scripts/autoloads/game_manager.gd
  - scripts/resources/feature_flags.gd
  - data/feature_flags.tres
  - project.godot
autonomous: true

must_haves:
  truths:
    - "Godot project launches and all four autoloads initialize without errors"
    - "EventBus declares signals for ad lifecycle, IAP, app state, banner region, and feature flags"
    - "GameManager tracks AppState enum and emits app_state_changed via EventBus on transitions"
    - "SaveData loads or creates FeatureFlags on startup"
    - "FeatureFlags static methods get_flag and set_flag work and emit feature_flag_changed signal"
    - "Project directory follows layered architecture (scripts/autoloads, scripts/resources, data, scenes/screens, scenes/ui)"
  artifacts:
    - path: "scripts/autoloads/event_bus.gd"
      provides: "Global signal relay for decoupled communication"
      contains: "signal ad_banner_loaded"
    - path: "scripts/autoloads/game_manager.gd"
      provides: "App state machine with enum-based transitions"
      contains: "enum AppState"
    - path: "scripts/autoloads/save_data.gd"
      provides: "Local persistence stub and FeatureFlags loader"
      contains: "FeatureFlags.instance"
    - path: "scripts/resources/feature_flags.gd"
      provides: "Boolean feature flag system with static access"
      contains: "class_name FeatureFlags"
    - path: "project.godot"
      provides: "Autoload registrations in correct order"
      contains: "autoload/EventBus"
  key_links:
    - from: "scripts/autoloads/game_manager.gd"
      to: "scripts/autoloads/event_bus.gd"
      via: "EventBus.app_state_changed.emit()"
      pattern: "EventBus\\.app_state_changed\\.emit"
    - from: "scripts/autoloads/save_data.gd"
      to: "scripts/resources/feature_flags.gd"
      via: "FeatureFlags.instance assignment on _ready"
      pattern: "FeatureFlags\\.instance\\s*="
    - from: "scripts/resources/feature_flags.gd"
      to: "scripts/autoloads/event_bus.gd"
      via: "EventBus.feature_flag_changed.emit() in set_flag"
      pattern: "EventBus\\.feature_flag_changed\\.emit"
---

<objective>
Create the project directory structure and core autoload skeleton (EventBus, GameManager, SaveData, FeatureFlags) that all subsequent plans depend on. Register autoloads in project.godot in the correct initialization order.

Purpose: Every subsequent phase and plan depends on these autoloads existing. EventBus prevents tight coupling between scenes. GameManager prevents ad-hoc state management. FeatureFlags enables the plugin fallback strategy (disable broken surfaces without code changes). This is the foundation that prevents future refactors.

Output: 5 new GDScript files, 1 resource file, updated project.godot with autoload registrations, and the layered directory structure.
</objective>

<execution_context>
@/Users/nathanielgiddens/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nathanielgiddens/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-validation-spikes/01-RESEARCH.md
@.planning/phases/01-foundation-and-validation-spikes/01-CONTEXT.md
@project.godot
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create directory structure and all autoload scripts</name>
  <files>
    scripts/autoloads/event_bus.gd
    scripts/autoloads/save_data.gd
    scripts/autoloads/game_manager.gd
    scripts/resources/feature_flags.gd
    data/feature_flags.tres
  </files>
  <action>
    Create the layered directory structure:
    - scripts/autoloads/
    - scripts/resources/
    - scripts/ui/
    - data/
    - scenes/screens/
    - scenes/ui/
    - addons/

    Create `scripts/autoloads/event_bus.gd` following the research Pattern 1 exactly:
    - extends Node
    - Declare signals: ad_banner_loaded, ad_banner_failed(error_code: int), ad_interstitial_loaded, ad_interstitial_closed, ad_rewarded_earned(reward_type: String, amount: int)
    - IAP signals: iap_purchase_completed(product_id: String), iap_purchase_failed(product_id: String, error: String), iap_restore_completed
    - App state signals: app_state_changed(old_state: String, new_state: String), screen_changed(screen_name: String)
    - Banner region signals: banner_region_show, banner_region_hide
    - Feature flag signals: feature_flag_changed(flag_name: String, value: bool)
    - NO logic in this file -- signals only (pure relay)

    Create `scripts/resources/feature_flags.gd` following research Pattern 4:
    - class_name FeatureFlags, extends Resource
    - static var instance: FeatureFlags
    - @export vars: ads_enabled, iap_enabled, banner_ads_enabled, interstitial_ads_enabled, rewarded_ads_enabled (all bool, default true)
    - static func get_flag(flag_name: String) -> bool
    - static func set_flag(flag_name: String, value: bool) -> void (emits EventBus.feature_flag_changed)

    Create `scripts/autoloads/save_data.gd` following the research SaveData stub:
    - extends Node
    - SAVE_PATH := "user://save_data.tres", FLAGS_PATH := "user://feature_flags.tres"
    - _ready() calls _load_feature_flags()
    - _load_feature_flags(): if ResourceLoader.exists(FLAGS_PATH), load it; else create new FeatureFlags and save
    - _save_feature_flags(): ResourceSaver.save()
    - save_game() and load_game() as pass stubs

    Create `scripts/autoloads/game_manager.gd` following research Pattern 2:
    - extends Node
    - enum AppState { LOADING, AUTH, MENU, PLAYING, PAUSED, RESULTS, STORE }
    - var current_state: AppState = AppState.LOADING
    - func transition_to(new_state: AppState) -> void -- emits EventBus.app_state_changed with string names
    - func _handle_state_entry(state: AppState) -> void -- match statement with pass for each state
    - func change_screen(scene_path: String) -> void -- calls get_tree().change_scene_to_file() and emits EventBus.screen_changed

    Create `data/feature_flags.tres` -- a default FeatureFlags resource with all flags true. Format:
    ```
    [gd_resource type="Resource" script_class="FeatureFlags" load_steps=2 format=3]
    [ext_resource type="Script" path="res://scripts/resources/feature_flags.gd" id="1"]
    [resource]
    script = ExtResource("1")
    ads_enabled = true
    iap_enabled = true
    banner_ads_enabled = true
    interstitial_ads_enabled = true
    rewarded_ads_enabled = true
    ```

    IMPORTANT: Use Godot 4.5 syntax throughout -- typed variables (var x: Type), typed signal parameters, Callable-based signal connections (signal.connect(method)), NOT the Godot 3 string-based syntax.
  </action>
  <verify>
    All files exist at their expected paths. Open project.godot in a text editor and confirm no syntax errors in the GDScript files by checking they parse as valid GDScript (no obvious typos, correct class_name declarations, proper extends statements). Each file should be non-empty and follow the patterns from 01-RESEARCH.md.
  </verify>
  <done>
    - event_bus.gd declares 12+ signals covering ads, IAP, app state, banner region, and feature flags
    - game_manager.gd has AppState enum with 7 states and transition_to() method that emits via EventBus
    - save_data.gd loads/creates FeatureFlags on _ready()
    - feature_flags.gd has class_name, static instance, get_flag/set_flag methods
    - Directory structure exists: scripts/autoloads/, scripts/resources/, scripts/ui/, data/, scenes/screens/, scenes/ui/, addons/
  </done>
</task>

<task type="auto">
  <name>Task 2: Register autoloads in project.godot and verify initialization</name>
  <files>
    project.godot
  </files>
  <action>
    Edit project.godot to add autoload registrations in the correct order (order matters -- later autoloads can reference earlier ones):

    Under the [autoload] section (create it if it doesn't exist), add:
    ```
    [autoload]

    EventBus="*res://scripts/autoloads/event_bus.gd"
    SaveData="*res://scripts/autoloads/save_data.gd"
    GameManager="*res://scripts/autoloads/game_manager.gd"
    ```

    NOTE: Do NOT register PlatformServices yet -- it will be created in Plan 02 and depends on EventBus + FeatureFlags which are created here.

    Also ensure the [application] section has:
    - run/main_scene="res://scenes/main.tscn" (point to existing main scene)

    Also add display settings for mobile:
    ```
    [display]

    window/size/viewport_width=1080
    window/size/viewport_height=1920
    window/stretch/mode="canvas_items"
    window/stretch/aspect="expand"
    window/handheld/orientation=1
    ```

    This sets portrait orientation (1 = portrait) at 1080x1920 base resolution with canvas_items stretch mode (the standard for 2D mobile games).

    After editing project.godot, verify the project can be opened by Godot without errors. If the Godot CLI is available, run: `godot --headless --quit` from the project directory to check for parse errors. If the CLI is not available, verify by reading the file and confirming valid INI format.
  </action>
  <verify>
    Read project.godot and confirm:
    1. [autoload] section exists with EventBus, SaveData, GameManager in correct order
    2. Each autoload path starts with "*res://" (the * means it auto-starts)
    3. [display] section has portrait orientation and 1080x1920 viewport
    4. [application] section has run/main_scene set
    5. No duplicate sections or malformed INI syntax

    If Godot CLI is available: `godot --headless --quit` exits cleanly (exit code 0).
  </verify>
  <done>
    - project.godot has 3 autoloads registered in order: EventBus, SaveData, GameManager
    - Display configured for portrait mobile (1080x1920, canvas_items stretch, expand aspect)
    - Main scene path set
    - Project opens without errors
  </done>
</task>

</tasks>

<verification>
Requirements covered by this plan:
- FNDN-05: Project directory structure follows layered architecture -- directories created, files placed in correct locations
- FNDN-06: EventBus autoload relays signals between decoupled scenes -- event_bus.gd with 12+ signals, registered as autoload
- FNDN-07: GameManager autoload manages app state transitions -- game_manager.gd with AppState enum and transition_to()

Cross-check: FeatureFlags and SaveData are not explicit requirements but are prerequisites for the plugin fallback strategy (CONTEXT.md decision) and the PlatformServices abstraction (Plan 02).
</verification>

<success_criteria>
1. All directories exist: scripts/autoloads/, scripts/resources/, scripts/ui/, data/, scenes/screens/, scenes/ui/, addons/
2. All autoload scripts exist and contain the patterns from 01-RESEARCH.md
3. project.godot registers 3 autoloads in order: EventBus -> SaveData -> GameManager
4. project.godot has mobile display settings (portrait, 1080x1920)
5. No GDScript syntax errors in any file
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-validation-spikes/01-01-SUMMARY.md`
</output>
