---
phase: 01-foundation-and-validation-spikes
plan: 04
type: execute
wave: 4
depends_on: ["01-03"]
files_modified:
  - addons/godot-admob/
  - addons/godot-iap/
  - scripts/autoloads/platform_services.gd
  - scenes/screens/test_screen.tscn
  - project.godot
autonomous: false

user_setup:
  - service: admob
    why: "AdMob test ads require the plugin installed and initialized; production ads require an AdMob account"
    env_vars: []
    dashboard_config:
      - task: "Create AdMob account (if not already created) for production ad unit IDs later"
        location: "admob.google.com"
      - task: "Note: Test ad unit IDs are built into the Google Mobile Ads SDK -- no account needed for spike validation"
        location: "N/A for test ads"
  - service: google-play-console
    why: "Android IAP sandbox testing requires a Google Play Console developer account"
    env_vars: []
    dashboard_config:
      - task: "Create Google Play Console developer account ($25 one-time fee)"
        location: "play.google.com/console"
      - task: "Create internal test app listing (required for sandbox IAP)"
        location: "Google Play Console > Create App"
      - task: "Add test account email to License Testing"
        location: "Google Play Console > Settings > License testing"
      - task: "Create at least one managed in-app product for testing"
        location: "Google Play Console > App > Monetize > In-app products"
  - service: app-store-connect
    why: "iOS IAP sandbox testing requires App Store Connect setup"
    env_vars: []
    dashboard_config:
      - task: "Create app record in App Store Connect"
        location: "appstoreconnect.apple.com > My Apps > New App"
      - task: "Create sandbox tester account"
        location: "App Store Connect > Users and Access > Sandbox > Testers"
      - task: "Create at least one in-app purchase product for testing"
        location: "App Store Connect > App > In-App Purchases > Create"

must_haves:
  truths:
    - "AdMob plugin loads and a test interstitial ad displays on a physical Android device"
    - "AdMob plugin loads and a test interstitial ad displays on a physical iOS device"
    - "IAP plugin loads and a sandbox purchase flow initiates on a physical Android device"
    - "IAP plugin loads and a sandbox purchase flow initiates on a physical iOS device"
    - "PlatformServices routes all ad and IAP calls through the abstraction layer -- no direct plugin calls from game code"
    - "Feature flags can disable ads or IAP at runtime without code changes"
  artifacts:
    - path: "addons/godot-admob/"
      provides: "AdMob plugin for banner, interstitial, and rewarded ads"
    - path: "scripts/autoloads/platform_services.gd"
      provides: "Wired abstraction layer with real plugin calls replacing stubs"
      contains: "_admob_initialized = true"
    - path: "scenes/screens/test_screen.tscn"
      provides: "Updated test screen with ad and IAP test results display"
      contains: "Test Interstitial"
  key_links:
    - from: "scripts/autoloads/platform_services.gd"
      to: "addons/godot-admob/"
      via: "AdMob node initialization and signal connections"
      pattern: "admob.*initialize|interstitial_ad"
    - from: "scripts/autoloads/platform_services.gd"
      to: "scripts/autoloads/event_bus.gd"
      via: "Emits ad and IAP lifecycle events"
      pattern: "EventBus\\.(ad_|iap_)"
    - from: "scripts/autoloads/platform_services.gd"
      to: "scripts/resources/feature_flags.gd"
      via: "Checks feature flags before every plugin operation"
      pattern: "FeatureFlags\\.get_flag"
---

<objective>
Install the AdMob and IAP plugins, wire them into PlatformServices (replacing stubs with real plugin calls), and validate that a test interstitial ad displays and a sandbox IAP purchase flow initiates on both physical devices.

Purpose: This is the monetization validation spike -- the highest-risk unknown in the project. If plugins don't work with Godot 4.5 on physical devices, we find out NOW before writing any game code. The PlatformServices abstraction means fallback plugins can be swapped in with minimal code changes.

Output: Working AdMob + IAP integration behind PlatformServices, validated on physical iOS and Android devices.
</objective>

<execution_context>
@/Users/nathanielgiddens/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nathanielgiddens/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-validation-spikes/01-RESEARCH.md
@.planning/phases/01-foundation-and-validation-spikes/01-CONTEXT.md
@.planning/phases/01-foundation-and-validation-spikes/01-01-SUMMARY.md
@.planning/phases/01-foundation-and-validation-spikes/01-02-SUMMARY.md
@.planning/phases/01-foundation-and-validation-spikes/01-03-SUMMARY.md
@scripts/autoloads/platform_services.gd
@scripts/autoloads/event_bus.gd
@scenes/screens/test_screen.tscn
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install AdMob plugin and wire into PlatformServices</name>
  <files>
    addons/godot-admob/
    scripts/autoloads/platform_services.gd
    project.godot
  </files>
  <action>
    **Install godot-sdk-integrations/godot-admob v5.3:**

    1. Download the plugin from GitHub releases: https://github.com/godot-sdk-integrations/godot-admob/releases (v5.3)
    2. Extract into the project's addons/ directory so the path is `addons/godot-admob/`
    3. Enable the plugin in project.godot under [editor_plugins] if needed, or ensure it is recognized by Godot

    The AdMob plugin works by adding an AdMob node to the scene tree. The plugin README documents this pattern.

    **Wire AdMob into PlatformServices:**

    Update `scripts/autoloads/platform_services.gd` to replace the ad stubs with real plugin calls:

    ```gdscript
    # In _init_ads():
    func _init_ads() -> void:
        # The AdMob plugin provides a singleton or requires an AdMob node in the scene
        # Check if the AdMob singleton/class exists at runtime
        if not ClassDB.class_exists("AdMob") and not Engine.has_singleton("AdMob"):
            push_warning("PlatformServices: AdMob plugin not found -- ads disabled")
            return

        # For the godot-sdk-integrations plugin, initialization happens via the AdMob node
        # We need to wait for the scene tree to be ready, then find/create the AdMob node
        call_deferred("_deferred_init_ads")

    func _deferred_init_ads() -> void:
        # Look for existing AdMob node or create one
        # The exact initialization depends on the plugin version
        # godot-sdk-integrations/godot-admob uses an AdMob node added to the scene
        # Follow the plugin's README for exact initialization steps
        #
        # General pattern:
        # 1. Add AdMob node to the scene tree (or use the plugin's autoload if it provides one)
        # 2. Connect initialization_completed signal
        # 3. Call initialize()
        # 4. On success: _admob_initialized = true, load interstitial
        #
        # Use Google's TEST ad unit IDs (built into the SDK):
        # Android interstitial test: ca-app-pub-3940256099942544/1033173712
        # iOS interstitial test: ca-app-pub-3940256099942544/4411468910
        # Android banner test: ca-app-pub-3940256099942544/6300978111
        # iOS banner test: ca-app-pub-3940256099942544/2934735716
        pass

    # Update show_interstitial to use real plugin:
    func show_interstitial() -> void:
        if not has_interstitial_ads():
            push_warning("PlatformServices: interstitial ads not available")
            return
        if not _interstitial_loaded:
            push_warning("PlatformServices: interstitial not loaded yet")
            return
        # Call plugin's show method
        # Connect closed signal -> EventBus.ad_interstitial_closed.emit()
        # After showing, pre-load next interstitial
        pass
    ```

    IMPORTANT implementation notes:
    - Use Google's TEST ad unit IDs for the spike (listed above). Do NOT use production IDs.
    - The exact API depends on the plugin version. Read the plugin's README and adapt.
    - Do NOT hardcode ad unit IDs in platform_services.gd. Store them in a config resource or as exported vars on the AdMob node. For the spike, exported vars on the node are acceptable.
    - Connect all AdMob lifecycle signals to EventBus equivalents (loaded, failed, closed, earned).
    - Add `var _interstitial_loaded := false` to track interstitial readiness.
    - After showing an interstitial, pre-load the next one.

    The plugin's exact API may differ from what research documented. Read the actual plugin source/README after installation and adapt PlatformServices accordingly. The interface (show_interstitial, show_rewarded, show_banner, hide_banner) stays the same -- only the internal implementation changes.

    FALLBACK: If godot-admob v5.3 fails to initialize on either platform, check the error output. Common issues:
    - Missing Google Mobile Ads SDK dependencies (check android/build.gradle)
    - iOS undefined symbols (per Pitfall 3 -- plugin version mismatch)
    - If unfixable within 1 day: leave ads stubs, document the failure, move on to IAP
  </action>
  <verify>
    1. addons/godot-admob/ directory exists with plugin files
    2. platform_services.gd has real AdMob initialization code (not just push_warning stubs)
    3. platform_services.gd uses test ad unit IDs (contains "ca-app-pub-3940256099942544")
    4. platform_services.gd connects AdMob signals to EventBus emissions
    5. platform_services.gd does NOT hardcode ad unit IDs inline in show/hide methods
    6. Project opens in Godot editor without plugin errors
  </verify>
  <done>
    - AdMob plugin installed in addons/godot-admob/
    - PlatformServices._init_ads() initializes AdMob plugin with test ad unit IDs
    - show_interstitial() calls the real plugin method (not stub)
    - show_banner() and hide_banner() call real plugin methods
    - All AdMob lifecycle signals wired to EventBus
  </done>
</task>

<task type="auto">
  <name>Task 2: Install IAP plugin and wire into PlatformServices</name>
  <files>
    addons/godot-iap/
    scripts/autoloads/platform_services.gd
  </files>
  <action>
    **Install IAP plugin (Primary: godot-iap v1.2.3):**

    1. Download godot-iap from: https://github.com/hyochan/godot-iap/releases (v1.2.3)
    2. Extract into addons/godot-iap/
    3. Enable in project settings if needed

    **Wire IAP into PlatformServices:**

    Update platform_services.gd to replace IAP stubs:

    ```gdscript
    func _init_iap() -> void:
        # Check if the IAP plugin is available
        # godot-iap uses the OpenIAP protocol
        # Follow the plugin's README for initialization
        #
        # General pattern:
        # 1. Get the IAP singleton/node
        # 2. Connect purchase signals (completed, failed, restored)
        # 3. Call initialize/start
        # 4. On success: _iap_initialized = true
        pass

    func purchase(product_id: String) -> void:
        if not has_iap():
            EventBus.iap_purchase_failed.emit(product_id, "IAP not available")
            return
        # Call plugin's purchase method with product_id
        # Plugin signals will fire -> we route them to EventBus
        pass

    func restore_purchases() -> void:
        if not has_iap():
            return
        # Call plugin's restore method
        # Signal fires -> EventBus.iap_restore_completed.emit()
        pass
    ```

    Connect IAP plugin signals to EventBus:
    - Purchase success -> EventBus.iap_purchase_completed.emit(product_id)
    - Purchase failure -> EventBus.iap_purchase_failed.emit(product_id, error)
    - Restore complete -> EventBus.iap_restore_completed.emit()

    **FALLBACK STRATEGY (if godot-iap fails within 2 days):**

    If godot-iap v1.2.3 does not work with Godot 4.5:
    1. Remove addons/godot-iap/
    2. For Android: Install godot-google-play-billing v3.1.0 or code-with-max/godot-google-play-iapp
       - Check build.gradle for Billing Library version (must be v6+ for Play Store acceptance)
       - If v3.1.0 has old Billing Library, use code-with-max (explicitly v7.1.1)
    3. For iOS: Install hrk4649/godot_ios_plugin_iap v0.3.0
       - This plugin says "confirmed Godot 4.6" -- it may work on 4.5 but needs testing
    4. PlatformServices already abstracts the interface, so the swap is:
       - Change _init_iap() internals to use platform-specific plugin
       - Use OS.get_name() to detect platform: "Android" or "iOS"
       - Route purchase/restore calls to the correct platform plugin

    The PlatformServices interface (purchase, restore_purchases, has_iap) does NOT change regardless of which plugin is behind it. This is the entire point of the abstraction layer.

    IMPORTANT: If ALL IAP plugins fail on a platform, set the feature flag:
    ```gdscript
    FeatureFlags.set_flag("iap_enabled", false)
    ```
    This disables IAP through PlatformServices without touching any other code. Document the failure for resolution before Phase 7.
  </action>
  <verify>
    1. IAP plugin directory exists (addons/godot-iap/ or platform-specific alternative)
    2. platform_services.gd has real IAP initialization code
    3. platform_services.gd purchase() method calls the real plugin (not stub)
    4. platform_services.gd connects IAP signals to EventBus emissions
    5. Platform detection logic exists if using separate plugins per platform
    6. Project opens in Godot editor without plugin errors
  </verify>
  <done>
    - IAP plugin installed (godot-iap or fallback)
    - PlatformServices._init_iap() initializes the IAP plugin
    - purchase() and restore_purchases() call real plugin methods
    - IAP lifecycle signals wired to EventBus
    - If using fallback: platform detection routes to correct plugin per OS
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Validate monetization plugins on physical devices</name>
  <what-built>
    AdMob plugin installed and wired into PlatformServices with test ad unit IDs.
    IAP plugin installed and wired into PlatformServices.
    Both plugins callable from the test screen buttons.
    All calls go through PlatformServices abstraction -- no direct plugin access.

    Test screen buttons:
    - "Show Banner" -- should load and display a Google test banner ad at bottom
    - "Hide Banner" -- should hide the banner and reflow layout
    - "Test Interstitial" -- should display a Google test interstitial ad
    - "Test IAP" -- should initiate a sandbox purchase flow
  </what-built>
  <how-to-verify>
    **Android device:**
    1. Export APK from Godot editor (Project > Export > Android > Export Project)
    2. Install on physical device: `adb install -r wordrun-test.apk`
    3. Launch the app
    4. Tap "Test Interstitial" -- a Google test ad should display (says "Test Ad" prominently)
    5. Close the test ad -- app should return to test screen
    6. Tap "Show Banner" -- a Google test banner should appear in the banner region at bottom
    7. Tap "Hide Banner" -- banner disappears, content expands (reflow)
    8. Tap "Test IAP" -- the Google Play purchase dialog should appear (if Play Console is set up) or an error message should display (if no IAP products configured yet)
    9. Check the output/logcat for any error messages: `adb logcat | grep -i "godot\|admob\|iap\|billing"`

    **iOS device:**
    1. Export Xcode project from Godot editor
    2. Open in Xcode, build and run on physical device
    3. Repeat steps 4-8 above using the iOS device
    4. For IAP: must be signed into a sandbox tester Apple ID on the device (Settings > App Store > Sandbox Account)

    **Expected results:**
    - FNDN-03 PASS: Test interstitial ad displays on BOTH platforms
    - FNDN-04 PASS: IAP purchase dialog appears on BOTH platforms (completing the purchase is optional for spike -- initiating the flow validates the plugin works)

    **Acceptable partial results:**
    - AdMob works on both but IAP only works on one platform -- document which, use feature flag to disable on the broken platform
    - IAP flow initiates but doesn't complete (sandbox config issue, not plugin issue) -- PASS for spike purposes
    - Banner ads display but look wrong -- PASS (visual polish is later)

    **Failure results requiring action:**
    - AdMob fails to initialize on either platform -- check plugin version compatibility
    - IAP plugin crashes the app -- swap to fallback plugin (see Task 2 fallback strategy)
    - Export with plugins fails entirely -- use Pitfall 1 workaround (export as Xcode project only, build in Xcode)
  </how-to-verify>
  <resume-signal>
    Report results:
    - "AdMob Android: pass/fail"
    - "AdMob iOS: pass/fail"
    - "IAP Android: pass/fail"
    - "IAP iOS: pass/fail"
    Include any error messages for failures. Type "all pass" if everything works, or describe partial results.
  </resume-signal>
</task>

</tasks>

<verification>
Requirements validated by this plan:
- FNDN-03: AdMob plugin loads and displays a test ad on both platforms (Task 3 AdMob verification)
- FNDN-04: IAP plugin completes a sandbox purchase on both platforms (Task 3 IAP verification)

This plan also validates:
- PlatformServices abstraction layer works end-to-end (game code -> PlatformServices -> plugin -> device)
- Feature flags can disable monetization surfaces (tested by toggling banner show/hide)
- Plugin fallback strategy is executable if primary plugins fail

Pitfall avoidance:
- C4 (Plugin ecosystem gaps): Spike validates plugins before any game code is written
- Pitfall 2 (Billing Library version): Check build.gradle during IAP plugin setup
- Pitfall 3 (iOS undefined symbols): Test incrementally -- base export already validated in Plan 03
- Pitfall 7 (Version churn): All plugins chosen for Godot 4.5 compatibility
</verification>

<success_criteria>
1. AdMob plugin installed and a test interstitial displays on at least one physical device (both platforms ideal)
2. IAP plugin installed and a sandbox purchase flow initiates on at least one physical device
3. All plugin calls go through PlatformServices -- no direct plugin access from test screen or other code
4. Feature flags can disable ads or IAP at runtime
5. If any plugin fails: fallback documented, feature flag disables broken surface, plan for resolution exists
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-validation-spikes/01-04-SUMMARY.md`
</output>
