---
phase: 01-foundation-and-validation-spikes
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - export_presets.cfg
  - scenes/screens/test_screen.tscn
autonomous: false

user_setup:
  - service: apple-developer
    why: "iOS export requires Apple Developer account for code signing"
    env_vars: []
    dashboard_config:
      - task: "Obtain App Store Team ID (10-character code)"
        location: "developer.apple.com > Account > Membership > Team ID"
      - task: "Ensure Xcode is installed with iOS support and xcode-select is configured"
        location: "macOS: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer"
  - service: android-sdk
    why: "Android export requires Android SDK and JDK"
    env_vars: []
    dashboard_config:
      - task: "Install Android Studio and Android SDK (Platform-Tools 35.0.0+)"
        location: "developer.android.com/studio"
      - task: "Install OpenJDK 17"
        location: "adoptium.net or brew install openjdk@17"
      - task: "Configure Godot Editor Settings with Java SDK and Android SDK paths"
        location: "Godot > Editor > Editor Settings > Android"

must_haves:
  truths:
    - "Godot project exports an APK/AAB that installs and runs on a physical Android device"
    - "Godot project exports an IPA/Xcode project that builds and runs on a physical iOS device"
    - "Test screen displays correctly on both physical devices in portrait orientation"
    - "Banner ad region is visible at bottom of screen on both devices"
    - "Banner show/hide buttons cause visible layout reflow on both devices"
    - "Safe area insets are respected on notched/Dynamic Island devices"
  artifacts:
    - path: "export_presets.cfg"
      provides: "Export presets for iOS and Android"
      contains: "platform=\"Android\""
    - path: "export_presets.cfg"
      provides: "Export presets for iOS and Android"
      contains: "platform=\"iOS\""
  key_links:
    - from: "export_presets.cfg"
      to: "project.godot"
      via: "Export reads project config, autoloads, main scene"
      pattern: "run/main_scene"
    - from: "scenes/screens/test_screen.tscn"
      to: "scenes/ui/banner_ad_region.tscn"
      via: "Banner region instance in test screen layout"
      pattern: "banner_ad_region"
---

<objective>
Configure export presets for iOS and Android, export the bare project (no monetization plugins yet), and validate the entire pipeline on physical devices. This is the critical risk-elimination step -- if export fails here, it's caught before any plugin complexity is added.

Purpose: The research recommends validating the bare export pipeline BEFORE adding plugins. This catches Xcode version issues, signing problems, Android SDK configuration errors, and safe area bugs early. The test screen from Plan 02 provides a visual confirmation that autoloads, banner region, and layout all work on real hardware.

Output: export_presets.cfg with iOS and Android presets, validated builds running on physical devices.
</objective>

<execution_context>
@/Users/nathanielgiddens/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nathanielgiddens/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-validation-spikes/01-RESEARCH.md
@.planning/phases/01-foundation-and-validation-spikes/01-CONTEXT.md
@.planning/phases/01-foundation-and-validation-spikes/01-01-SUMMARY.md
@.planning/phases/01-foundation-and-validation-spikes/01-02-SUMMARY.md
@project.godot
@export_presets.cfg
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure export presets for iOS and Android</name>
  <files>
    export_presets.cfg
  </files>
  <action>
    Ensure Godot export templates for 4.5 are installed. Check via:
    - Look for templates at the standard location: `~/.local/share/godot/export_templates/4.5.stable/` (Linux) or `~/Library/Application Support/Godot/export_templates/4.5.stable/` (macOS)
    - If templates don't exist, they must be downloaded via Godot Editor > Manage Export Templates (this may require user action if Godot CLI can't do it headlessly)

    Configure Android export preset:
    1. If export_presets.cfg does not exist, create it with an Android preset. The fastest way is to use the Godot editor. Alternatively, create the file manually with these essential fields:
       - platform="Android"
       - Bundle identifier: com.wordrun.game (or similar)
       - Architectures: arm64 only for development (faster builds)
       - Min SDK: 24 (Android 7.0 -- standard for modern games)
       - Target SDK: 34 (latest stable)
       - Screen orientation: Portrait
    2. Install Android build template: This requires running Godot editor (Project > Install Android Build Template), which creates the `android/` directory in the project. If the android/ directory doesn't exist, the user needs to do this step in the Godot editor.
    3. The debug keystore is auto-generated by Godot 4.5 -- no manual step needed.

    Configure iOS export preset:
    1. Add iOS preset to export_presets.cfg:
       - platform="iOS"
       - Bundle identifier: com.wordrun.game
       - App Store Team ID: The user's 10-character Team ID (from Apple Developer account)
       - Use automatic signing (do NOT set manual provisioning profile or codesign identity -- avoids Pitfall 5)
       - Orientation: Portrait
       - Required device capabilities: arm64

    IMPORTANT: Do NOT commit credentials, keys, or Team IDs to git. Add to .gitignore if not already:
    ```
    export_presets.cfg
    *.keystore
    android/
    ```

    The export_presets.cfg contains signing information and should not be in version control.

    Attempt to export:
    - Android: `godot --headless --export-debug "Android" /tmp/wordrun-test.apk` (or use the editor)
    - iOS: `godot --headless --export-debug "iOS" /tmp/wordrun-ios/` (exports as Xcode project)

    If headless export is not possible (common for iOS which needs Xcode), document the manual steps the user must follow:
    1. Open project in Godot editor
    2. Project > Export > select preset > Export Project
    3. For Android: export as APK, install via `adb install wordrun-test.apk`
    4. For iOS: export as Xcode project, open in Xcode, build to device

    CRITICAL per research Pitfall 1: Export with NO plugins first. The addons/ directory should have no monetization plugins at this point. If the export fails, the issue is in the base pipeline, not plugins.
  </action>
  <verify>
    1. export_presets.cfg exists with both Android and iOS presets
    2. .gitignore includes export_presets.cfg and *.keystore
    3. Android preset has arm64 architecture, portrait orientation, and valid bundle ID
    4. iOS preset has automatic signing (no manual provisioning profile), portrait orientation, and valid bundle ID
    5. If export was attempted: check for output files (APK for Android, Xcode project for iOS)
  </verify>
  <done>
    - export_presets.cfg exists with Android and iOS presets configured
    - Export credentials excluded from version control
    - At least one platform export attempted (Android APK or iOS Xcode project generated)
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Validate bare export on physical devices</name>
  <what-built>
    Bare Godot project (no monetization plugins) with test screen showing:
    - Autoload status labels (EventBus, GameManager, SaveData, PlatformServices loaded)
    - Banner ad region at bottom with artwork placeholder
    - Show/Hide banner buttons that toggle the region with layout reflow
    - App state display from GameManager

    Export presets configured for both iOS and Android.
  </what-built>
  <how-to-verify>
    **Android:**
    1. In Godot editor: Project > Export > Android > Export Project (APK)
    2. Connect Android device via USB with developer mode enabled
    3. Install: `adb install -r wordrun-test.apk`
    4. Launch the app on the device
    5. Verify:
       - App opens in portrait orientation
       - Test screen displays with "WordRun! Test Screen" heading
       - All 4 autoload status labels show "loaded"
       - Banner ad region is visible at bottom with placeholder
       - Tap "Hide Banner" -- banner disappears and content area expands (reflow)
       - Tap "Show Banner" -- banner reappears and content area shrinks back
       - On a notched device: banner does not overlap the navigation bar

    **iOS:**
    1. In Godot editor: Project > Export > iOS > Export Project (select empty folder)
    2. Open the generated .xcodeproj in Xcode
    3. Select your physical iOS device as build target
    4. Build and Run (Cmd+R)
    5. Verify the same 6 items as Android above
    6. On a notched/Dynamic Island device: verify safe area is respected (banner doesn't overlap home indicator)

    **If either platform fails to export:** Note the exact error message. Common fixes:
    - Android "no export template": Editor > Manage Export Templates > Download
    - iOS "code signing": Check Team ID in export preset; ensure valid Apple Developer membership
    - iOS Xcode build failure with "code 0": Try exporting with "create only project file" option (per Pitfall 1)
  </how-to-verify>
  <resume-signal>
    Report results for each platform:
    - "Android: pass" or "Android: fail - [error]"
    - "iOS: pass" or "iOS: fail - [error]"
    Type "both pass" if both platforms work, or describe issues for troubleshooting.
  </resume-signal>
</task>

</tasks>

<verification>
Requirements validated by this plan:
- FNDN-01: Godot project exports and runs on a physical iOS device (Task 2 iOS verification)
- FNDN-02: Godot project exports and runs on a physical Android device (Task 2 Android verification)
- FNDN-08: Banner ad region visible, hides with reflow (Task 2 banner verification on both devices)

Pitfall avoidance:
- C1 (Export pipeline blindsides): This plan exports BEFORE any plugin code is added
- Pitfall 1 (Xcode 26): Base export with no plugins isolates the pipeline from plugin issues
- Pitfall 5 (Signing conflicts): Automatic signing only, no manual provisioning
</verification>

<success_criteria>
1. export_presets.cfg exists with Android and iOS presets
2. Android APK installs and runs on a physical device -- test screen displays correctly
3. iOS Xcode project builds and runs on a physical device -- test screen displays correctly
4. Banner region shows/hides with layout reflow on both platforms
5. Safe area insets are respected on notched devices
6. No monetization plugins are present in the build (clean base pipeline validation)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-validation-spikes/01-03-SUMMARY.md`
</output>
