---
phase: 01-foundation-and-validation-spikes
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - scripts/autoloads/platform_services.gd
  - scripts/ui/banner_ad_region.gd
  - scenes/ui/banner_ad_region.tscn
  - scenes/screens/test_screen.tscn
  - scenes/main.tscn
  - project.godot
autonomous: true

must_haves:
  truths:
    - "PlatformServices autoload provides has_ads(), has_iap(), show_interstitial(), show_rewarded(), show_banner(), hide_banner(), purchase(), restore_purchases() methods"
    - "Banner ad region displays at bottom of test screen with artwork fallback placeholder"
    - "Toggling banner region on/off causes layout reflow -- content above expands to fill the space"
    - "PlatformServices checks FeatureFlags before any ad/IAP operation"
    - "Test screen has buttons to trigger banner show/hide and demonstrates the reflow"
  artifacts:
    - path: "scripts/autoloads/platform_services.gd"
      provides: "Abstraction layer for all monetization plugin calls"
      contains: "func show_interstitial"
    - path: "scripts/ui/banner_ad_region.gd"
      provides: "Safe-area-aware collapsible banner container"
      contains: "_apply_safe_area_bottom"
    - path: "scenes/ui/banner_ad_region.tscn"
      provides: "Reusable banner ad region scene"
      contains: "banner_ad_region.gd"
    - path: "scenes/screens/test_screen.tscn"
      provides: "Test screen demonstrating banner toggle and layout reflow"
      contains: "BannerAdRegion"
    - path: "scenes/main.tscn"
      provides: "Root scene loading test screen"
      contains: "test_screen"
  key_links:
    - from: "scripts/autoloads/platform_services.gd"
      to: "scripts/resources/feature_flags.gd"
      via: "FeatureFlags.get_flag() calls in has_ads() and has_iap()"
      pattern: "FeatureFlags\\.get_flag"
    - from: "scripts/autoloads/platform_services.gd"
      to: "scripts/autoloads/event_bus.gd"
      via: "EventBus signal emissions for banner show/hide and IAP events"
      pattern: "EventBus\\.(banner_region|iap_)"
    - from: "scripts/ui/banner_ad_region.gd"
      to: "scripts/autoloads/event_bus.gd"
      via: "Connects to EventBus.banner_region_show and banner_region_hide"
      pattern: "EventBus\\.banner_region_(show|hide)\\.connect"
---

<objective>
Create the PlatformServices autoload (abstraction layer for all monetization plugins), the collapsible banner ad region UI component, and a test screen that demonstrates banner toggle with layout reflow. Wire PlatformServices as the fourth autoload.

Purpose: PlatformServices ensures game code never calls plugin methods directly -- every ad and IAP operation goes through this stable internal API, making plugin swaps zero-cost. The banner ad region is a reusable component that every future screen will include. The test screen validates the layout reflow behavior before real ads exist.

Output: PlatformServices autoload, banner ad region scene + script, test screen scene, updated main.tscn and project.godot.
</objective>

<execution_context>
@/Users/nathanielgiddens/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nathanielgiddens/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-validation-spikes/01-RESEARCH.md
@.planning/phases/01-foundation-and-validation-spikes/01-CONTEXT.md
@.planning/phases/01-foundation-and-validation-spikes/01-01-SUMMARY.md
@project.godot
@scripts/autoloads/event_bus.gd
@scripts/resources/feature_flags.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PlatformServices autoload and register it</name>
  <files>
    scripts/autoloads/platform_services.gd
    project.godot
  </files>
  <action>
    Create `scripts/autoloads/platform_services.gd` following research Pattern 3:

    ```gdscript
    extends Node

    # --- Internal state ---
    var _admob_initialized := false
    var _iap_initialized := false

    func _ready() -> void:
        _init_ads()
        _init_iap()

    # --- Feature capability checks ---
    func has_ads() -> bool:
        return FeatureFlags.get_flag("ads_enabled") and _admob_initialized

    func has_iap() -> bool:
        return FeatureFlags.get_flag("iap_enabled") and _iap_initialized

    func has_banner_ads() -> bool:
        return has_ads() and FeatureFlags.get_flag("banner_ads_enabled")

    func has_interstitial_ads() -> bool:
        return has_ads() and FeatureFlags.get_flag("interstitial_ads_enabled")

    func has_rewarded_ads() -> bool:
        return has_ads() and FeatureFlags.get_flag("rewarded_ads_enabled")

    # --- Ads interface ---
    func show_interstitial() -> void:
        if not has_interstitial_ads():
            return
        # Plugin-specific call will be wired in Plan 03
        push_warning("PlatformServices: show_interstitial() stub -- no plugin wired yet")

    func show_rewarded() -> void:
        if not has_rewarded_ads():
            return
        push_warning("PlatformServices: show_rewarded() stub -- no plugin wired yet")

    func show_banner() -> void:
        if not has_banner_ads():
            return
        EventBus.banner_region_show.emit()
        push_warning("PlatformServices: show_banner() stub -- no plugin wired yet")

    func hide_banner() -> void:
        EventBus.banner_region_hide.emit()

    # --- IAP interface ---
    func purchase(product_id: String) -> void:
        if not has_iap():
            EventBus.iap_purchase_failed.emit(product_id, "IAP not available")
            return
        push_warning("PlatformServices: purchase() stub -- no plugin wired yet")

    func restore_purchases() -> void:
        if not has_iap():
            return
        push_warning("PlatformServices: restore_purchases() stub -- no plugin wired yet")

    # --- Initialization stubs ---
    func _init_ads() -> void:
        # Will be replaced with actual AdMob initialization in Plan 03
        push_warning("PlatformServices: _init_ads() stub -- no AdMob plugin installed yet")

    func _init_iap() -> void:
        # Will be replaced with actual IAP initialization in Plan 03
        push_warning("PlatformServices: _init_iap() stub -- no IAP plugin installed yet")
    ```

    IMPORTANT design decisions:
    - show_banner() emits EventBus.banner_region_show BEFORE the actual plugin call, so the UI region shows immediately (plugin ad loads async and fills in later)
    - hide_banner() always emits the hide signal regardless of plugin state (collapsing the region is a UI concern, not a plugin concern)
    - All stubs use push_warning() so they are visible in the Godot output panel but don't crash
    - Granular capability checks (has_banner_ads, has_interstitial_ads, has_rewarded_ads) each consult their own FeatureFlag

    Add PlatformServices to project.godot autoloads AFTER GameManager:
    ```
    PlatformServices="*res://scripts/autoloads/platform_services.gd"
    ```

    The autoload order should now be: EventBus, SaveData, GameManager, PlatformServices.
  </action>
  <verify>
    1. Read platform_services.gd and confirm it has: has_ads(), has_iap(), has_banner_ads(), has_interstitial_ads(), has_rewarded_ads(), show_interstitial(), show_rewarded(), show_banner(), hide_banner(), purchase(), restore_purchases()
    2. Read project.godot and confirm PlatformServices is the 4th autoload after GameManager
    3. Confirm platform_services.gd references FeatureFlags.get_flag() and EventBus signals
  </verify>
  <done>
    - PlatformServices autoload exists with complete ads/IAP interface (stubs)
    - All public methods check FeatureFlags before operating
    - show_banner/hide_banner emit EventBus signals
    - Registered as 4th autoload in project.godot
  </done>
</task>

<task type="auto">
  <name>Task 2: Create banner ad region component and test screen</name>
  <files>
    scripts/ui/banner_ad_region.gd
    scenes/ui/banner_ad_region.tscn
    scenes/screens/test_screen.tscn
    scenes/main.tscn
  </files>
  <action>
    Create `scripts/ui/banner_ad_region.gd` following research Pattern 5:

    The banner ad region is a MarginContainer that:
    - Anchors to the bottom of its parent
    - Reserves space for a banner ad (default 80px height)
    - Respects device safe area insets via DisplayServer.get_display_safe_area()
    - Shows artwork fallback (a ColorRect placeholder with a Label for now -- real artwork comes in later phases)
    - Listens to EventBus.banner_region_show and banner_region_hide
    - When hidden: sets visible=false AND custom_minimum_size.y=0 so parent layout reflows
    - When shown: restores visibility and minimum size

    ```gdscript
    extends MarginContainer

    @export var default_height: int = 80
    @export var show_artwork_fallback: bool = true

    var _is_collapsed: bool = false

    func _ready() -> void:
        _apply_safe_area_bottom()
        EventBus.banner_region_show.connect(_on_show)
        EventBus.banner_region_hide.connect(_on_hide)
        # Start visible with artwork placeholder
        if show_artwork_fallback:
            _show_artwork()
        custom_minimum_size.y = default_height

    func _apply_safe_area_bottom() -> void:
        var screen_size := DisplayServer.screen_get_size()
        var safe_area := DisplayServer.get_display_safe_area()
        var bottom_inset: int = screen_size.y - (safe_area.position.y + safe_area.size.y)
        if bottom_inset > 0:
            add_theme_constant_override("margin_bottom", bottom_inset)

    func _on_show() -> void:
        _is_collapsed = false
        visible = true
        custom_minimum_size.y = default_height

    func _on_hide() -> void:
        _is_collapsed = true
        visible = false
        custom_minimum_size.y = 0

    func _show_artwork() -> void:
        # Placeholder -- real game artwork with idle animation added in later phases
        # For now, add a colored rectangle as visual indicator
        pass
    ```

    Create `scenes/ui/banner_ad_region.tscn`:
    - Root node: MarginContainer named "BannerAdRegion" with banner_ad_region.gd attached
    - Child: ColorRect named "ArtworkPlaceholder" with a muted color (e.g., Color(0.15, 0.15, 0.2, 1.0) -- dark blue-gray)
    - Child of ColorRect: Label named "PlaceholderLabel" centered, text "Ad Space" in small font, subtle opacity
    - Set the MarginContainer's custom_minimum_size.y = 80
    - Set size_flags_horizontal = SIZE_EXPAND_FILL so it stretches full width

    Create `scenes/screens/test_screen.tscn`:
    - Root node: VBoxContainer named "TestScreen" (full screen, anchors preset FULL_RECT)
    - Child 1: VBoxContainer named "ContentArea" with size_flags_vertical = SIZE_EXPAND_FILL (this is the main content that expands when banner collapses)
      - Child: Label "WordRun! Test Screen" centered, large
      - Child: Label "Architecture Validation" centered, smaller
      - Child: HSeparator
      - Child: Label "Autoload Status:" bold
      - Child: Label showing "EventBus: loaded" (check at runtime)
      - Child: Label showing "GameManager: loaded" (check at runtime)
      - Child: Label showing "SaveData: loaded" (check at runtime)
      - Child: Label showing "PlatformServices: loaded" (check at runtime)
      - Child: HSeparator
      - Child: HBoxContainer with two buttons:
        - Button "Show Banner" -- on pressed: PlatformServices.show_banner()
        - Button "Hide Banner" -- on pressed: PlatformServices.hide_banner()
      - Child: HBoxContainer with two buttons:
        - Button "Test Interstitial" -- on pressed: PlatformServices.show_interstitial()
        - Button "Test IAP" -- on pressed: PlatformServices.purchase("test_product")
      - Child: Label "State:" and Label showing GameManager.current_state (update on app_state_changed)
    - Child 2: Instance of banner_ad_region.tscn named "BannerAdRegion" (at bottom of VBoxContainer)

    Attach a script to test_screen.tscn that:
    - On _ready(), checks each autoload exists and updates status labels
    - Connects button signals to PlatformServices methods
    - Connects EventBus.app_state_changed to update state label
    - Uses GameManager.transition_to(GameManager.AppState.MENU) on _ready to demonstrate the state machine

    Update `scenes/main.tscn` to load test_screen.tscn as its main content. The simplest approach: change main.tscn's root to a Node that instances test_screen.tscn, OR set the main scene to test_screen.tscn directly in project.godot. Preferred: update project.godot to set run/main_scene="res://scenes/screens/test_screen.tscn" so the test screen launches directly.

    IMPORTANT layout requirements:
    - The VBoxContainer layout means: ContentArea expands to fill available space, BannerAdRegion sits at bottom
    - When BannerAdRegion hides (visible=false, min_size.y=0), ContentArea automatically expands to fill the full screen height
    - This is the "reflow" behavior required by FNDN-08
    - Touch targets (buttons) must be at least 48dp (use custom_minimum_size of at least 48x48 on buttons)
  </action>
  <verify>
    1. All 4 files exist at their expected paths
    2. banner_ad_region.gd connects to EventBus.banner_region_show and banner_region_hide
    3. banner_ad_region.gd sets custom_minimum_size.y=0 on hide (enabling reflow)
    4. test_screen.tscn instances BannerAdRegion at the bottom of a VBoxContainer
    5. test_screen.tscn has "Show Banner" and "Hide Banner" buttons wired to PlatformServices
    6. project.godot main_scene points to test_screen.tscn

    If Godot CLI available: `godot --headless --quit` exits cleanly.
  </verify>
  <done>
    - Banner ad region scene exists with safe-area-aware bottom anchoring, show/hide via EventBus, layout reflow on collapse
    - Test screen displays autoload status, has banner toggle buttons, demonstrates state machine
    - Content area expands when banner is hidden (reflow verified by VBoxContainer layout)
    - Main scene points to test screen for immediate validation
  </done>
</task>

</tasks>

<verification>
Requirements covered by this plan:
- FNDN-08: All screen layouts reserve a collapsible bottom banner ad region that refluxes when toggled off -- banner_ad_region.tscn with show/hide/reflow behavior
- PlatformServices foundation (prerequisite for FNDN-03 and FNDN-04 in Plans 03/04)

The test screen serves as visual validation for FNDN-05 (directory structure in action), FNDN-06 (EventBus signals working), FNDN-07 (GameManager state transitions), and FNDN-08 (banner reflow).
</verification>

<success_criteria>
1. PlatformServices autoload has complete ads/IAP interface with FeatureFlag checks
2. Banner ad region shows at bottom, hides with layout reflow (content expands to fill space)
3. Test screen renders with autoload status, banner toggle buttons, and state display
4. All 4 autoloads registered in project.godot in correct order
5. Project launches to test screen without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-validation-spikes/01-02-SUMMARY.md`
</output>
