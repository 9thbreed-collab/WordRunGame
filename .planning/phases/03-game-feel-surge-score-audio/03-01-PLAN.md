# Plan 03-01: Surge System and Scoring
Phase: 3 -- Game Feel, Surge, Score, and Audio
Depends on: Phase 2 complete

## Context References
- scripts/autoloads/event_bus.gd
- scripts/resources/level_data.gd
- scripts/screens/gameplay_screen.gd
- scenes/screens/gameplay_screen.tscn
- scripts/screens/results_screen.gd
- scenes/screens/results_screen.tscn
- .planning/phases/03-game-feel-surge-score-audio/03-RESEARCH.md

## Tasks

### Task 1: Create SurgeConfig Resource
**Files:** Create scripts/resources/surge_config.gd
**Steps:**
1. Define class_name SurgeConfig extends Resource
2. Add @export properties:
   - max_value: float = 100.0
   - fill_per_word: float = 15.0
   - idle_drain_rate: float = 2.0 (points/sec)
   - imminent_drain_rate: float = 8.0 (faster drain after final threshold)
   - thresholds: Array[float] = [30.0, 60.0, 90.0] (surge values where multiplier increases)
   - multipliers: Array[float] = [1.0, 1.5, 2.0, 3.0] (multiplier at each level; index 0 = below first threshold)

### Task 2: Add SurgeConfig to LevelData
**Files:** Modify scripts/resources/level_data.gd, Modify data/levels/test_level_01.tres
**Steps:**
1. Add @export var surge_config: SurgeConfig to LevelData
2. Update test_level_01.tres with a SurgeConfig sub_resource using the default values above

### Task 3: Add EventBus Surge Signals
**Files:** Modify scripts/autoloads/event_bus.gd
**Steps:**
1. Add signals:
   - signal surge_changed(current_value: float, max_value: float)
   - signal surge_threshold_crossed(new_multiplier: float)
   - signal surge_bust()
   - signal score_updated(new_score: int)

### Task 4: Create SurgeSystem Node
**Files:** Create scripts/gameplay/surge_system.gd
**Steps:**
1. Define as Node (not autoload -- lives as child of GameplayScreen)
2. enum State { IDLE, FILLING, IMMINENT, BUSTED }
3. Properties: _surge_value, _config (SurgeConfig), _state, _current_multiplier, _was_imminent (tracks if we entered imminent zone)
4. func start(config: SurgeConfig) -- initializes from resource
5. func fill() -- called on word completion, adds fill_per_word to _surge_value (capped at max_value)
6. _process(delta): drain logic
   - If state == BUSTED: tween drain to zero, ignore fills
   - If state == IMMINENT: drain at imminent_drain_rate * delta
   - Else: drain at idle_drain_rate * delta
7. Threshold detection: after fill or drain, check _surge_value against config.thresholds
   - When crossing UP into a higher threshold: emit EventBus.surge_threshold_crossed with new multiplier
   - When _surge_value >= config.thresholds[-1] (final threshold): set state to IMMINENT, set _was_imminent = true
   - When _was_imminent and _surge_value < config.thresholds[-1]: BUST -- set state to BUSTED, emit EventBus.surge_bust
8. Emit EventBus.surge_changed on every value change (for UI updates)
9. func get_multiplier() -> float -- returns current multiplier based on which threshold bracket we're in

### Task 5: Create Surge Bar UI
**Files:** Create scenes/ui/surge_bar.tscn, Create scripts/ui/surge_bar.gd
**Steps:**
1. Root node: Control with script
2. Child: ProgressBar (or TextureProgressBar) with min_value=0, max_value=100
3. Child threshold markers: ColorRect nodes positioned at threshold percentages
4. func setup(config: SurgeConfig) -- positions threshold markers
5. func update_value(current: float, max_val: float) -- tweens bar value smoothly
6. Connect to EventBus.surge_changed in _ready()

### Task 6: Update Gameplay HUD and Scene
**Files:** Modify scenes/screens/gameplay_screen.tscn
**Steps:**
1. Add %ScoreLabel to HUD (between Spacer and WordCountLabel or below HUD)
2. Add %MultiplierLabel to HUD
3. Add SurgeBar instance above or below WordDisplayPanel
4. Add a child Node named SurgeSystem (will be configured via script)

### Task 7: Wire SurgeSystem in GameplayScreen
**Files:** Modify scripts/screens/gameplay_screen.gd
**Steps:**
1. Add @onready refs: _score_label, _multiplier_label, _surge_system, _surge_bar
2. Add var _score: int = 0, var _current_multiplier: float = 1.0
3. In _ready(): call _surge_system.start(_level_data.surge_config), _surge_bar.setup(_level_data.surge_config)
4. Connect EventBus.surge_threshold_crossed to _on_multiplier_changed
5. Connect EventBus.surge_bust to _on_surge_bust
6. In _on_word_completed: call _surge_system.fill(), calculate score (BASE_SCORE * _current_multiplier), update _score, emit EventBus.score_updated, update labels
7. _on_multiplier_changed: update _current_multiplier, update label
8. _on_surge_bust: handle bust (multiplier reset to 1.0, visual feedback)

### Task 8: Pass Score to ResultsScreen
**Files:** Modify scripts/autoloads/game_manager.gd, Modify scripts/screens/results_screen.gd
**Steps:**
1. Add var last_score: int = 0, var last_time_elapsed: int = 0 to GameManager
2. In GameplayScreen._level_complete: set GameManager.last_score and last_time_elapsed before emitting level_completed
3. In ResultsScreen._ready: read GameManager.last_score and display it
4. Show final time elapsed on results screen

## Verification
- Surge bar appears on gameplay screen with visible threshold markers
- Bar fills on word completion and drains when idle
- Multiplier label updates when crossing thresholds
- Entering imminent zone (past final threshold) increases drain visibly
- Dropping below final threshold after being in imminent zone triggers bust
- Score accumulates with multiplier applied
- Results screen shows final score

## Decisions
- 03-01-D1: SurgeSystem lives as child node of GameplayScreen (not autoload) -- scoped to gameplay
- 03-01-D2: Bust triggers when surge drops below final threshold after having entered imminent zone (per SRGE-06)
- 03-01-D3: Score calculated in GameplayScreen (owns both word events and multiplier)
- 03-01-D4: Score passed to ResultsScreen via GameManager properties (simple decoupling)
